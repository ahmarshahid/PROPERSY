{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/FRONTEND/interent/app/api/n8n-proxy/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\nexport const runtime = \"edge\"; // 或 \"nodejs\"；如果需要使用 node 包，可以切换为 \"nodejs\"\r\n\r\nfunction corsHeaders(extra: Record<string, string> = {}) {\r\n  return {\r\n    \"Access-Control-Allow-Origin\": \"*\",\r\n    ...extra,\r\n  };\r\n}\r\n\r\nexport async function OPTIONS() {\r\n  return new Response(null, {\r\n    status: 204,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type\",\r\n    },\r\n  });\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  const webhook = process.env.N8N_WEBHOOK_URL;\r\n\r\n  // 开发阶段打印一下是否读取到了环境变量（生产环境可以删除）\r\n  // 只打印 host，避免完整 URL 被打到日志里\r\n  try {\r\n    const host = webhook ? new URL(webhook).host : \"(未定义)\";\r\n    // eslint-disable-next-line no-console\r\n    console.log(\"[n8n-proxy] N8N_WEBHOOK_URL 主机 =\", host);\r\n  } catch {\r\n    // 忽略错误\r\n  }\r\n\r\n  if (!webhook) {\r\n    return NextResponse.json(\r\n      {\r\n        error: \"缺少 N8N_WEBHOOK_URL\",\r\n        hint: \"请在项目根目录下创建 .env.local 文件，并设置 N8N_WEBHOOK_URL=https://<workspace>.app.n8n.cloud/ai-chat/<workflowId>，然后重新启动开发服务器。\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  const url = new URL(req.url);\r\n  const wantStream = url.searchParams.get(\"stream\") === \"1\";\r\n\r\n  try {\r\n    const contentType = req.headers.get(\"content-type\") || \"\";\r\n    let body: BodyInit;\r\n\r\n    if (contentType.includes(\"multipart/form-data\")) {\r\n      const form = await req.formData();\r\n      const out = new FormData();\r\n      for (const [k, v] of form.entries()) {\r\n        if (typeof v === \"string\") out.append(k, v);\r\n        else out.append(k, v, (v as File).name);\r\n      }\r\n      body = out;\r\n    } else if (contentType.includes(\"application/json\")) {\r\n      const json = await req.json();\r\n      body = JSON.stringify(json);\r\n    } else {\r\n      body = await req.text();\r\n    }\r\n\r\n    // 转发到 n8n，上游尽量保持分块传输\r\n    const upstream = await fetch(webhook, {\r\n      method: \"POST\",\r\n      body,\r\n      headers: contentType.includes(\"multipart/form-data\")\r\n        ? undefined\r\n        : { \"content-type\": contentType },\r\n      cache: \"no-store\",\r\n    });\r\n\r\n    const resType = upstream.headers.get(\"content-type\") || \"\";\r\n\r\n    if (wantStream) {\r\n      // 流式直通\r\n      return new Response(upstream.body, {\r\n        status: upstream.status,\r\n        headers: corsHeaders({\r\n          \"content-type\": resType || \"text/plain\",\r\n        }),\r\n      });\r\n    }\r\n\r\n    // 非流式：收完再返回\r\n    if (resType.includes(\"application/json\")) {\r\n      const data = await upstream.json();\r\n      return NextResponse.json(data, { headers: corsHeaders() });\r\n    } else {\r\n      const text = await upstream.text();\r\n      return new Response(text, {\r\n        headers: corsHeaders({ \"content-type\": resType || \"text/plain\" }),\r\n      });\r\n    }\r\n  } catch (e: any) {\r\n    // eslint-disable-next-line no-console\r\n    console.error(\"[n8n-proxy] 错误:\", e);\r\n    return NextResponse.json(\r\n      { error: e?.message || String(e) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AAEO,MAAM,UAAU,QAAQ,0CAA0C;AAEzE,SAAS,YAAY,QAAgC,CAAC,CAAC;IACrD,OAAO;QACL,+BAA+B;QAC/B,GAAG,KAAK;IACV;AACF;AAEO,eAAe;IACpB,OAAO,IAAI,SAAS,MAAM;QACxB,QAAQ;QACR,SAAS;YACP,+BAA+B;YAC/B,gCAAgC;YAChC,gCAAgC;QAClC;IACF;AACF;AAEO,eAAe,KAAK,GAAY;IACrC,MAAM,UAAU,QAAQ,GAAG,CAAC,eAAe;IAE3C,+BAA+B;IAC/B,2BAA2B;IAC3B,IAAI;QACF,MAAM,OAAO,UAAU,IAAI,IAAI,SAAS,IAAI,GAAG;QAC/C,sCAAsC;QACtC,QAAQ,GAAG,CAAC,oCAAoC;IAClD,EAAE,OAAM;IACN,OAAO;IACT;IAEA,IAAI,CAAC,SAAS;QACZ,OAAO,0NAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,MAAM;QACR,GACA;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAC3B,MAAM,aAAa,IAAI,YAAY,CAAC,GAAG,CAAC,cAAc;IAEtD,IAAI;QACF,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACvD,IAAI;QAEJ,IAAI,YAAY,QAAQ,CAAC,wBAAwB;YAC/C,MAAM,OAAO,MAAM,IAAI,QAAQ;YAC/B,MAAM,MAAM,IAAI;YAChB,KAAK,MAAM,CAAC,GAAG,EAAE,IAAI,KAAK,OAAO,GAAI;gBACnC,IAAI,OAAO,MAAM,UAAU,IAAI,MAAM,CAAC,GAAG;qBACpC,IAAI,MAAM,CAAC,GAAG,GAAG,AAAC,EAAW,IAAI;YACxC;YACA,OAAO;QACT,OAAO,IAAI,YAAY,QAAQ,CAAC,qBAAqB;YACnD,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,OAAO,KAAK,SAAS,CAAC;QACxB,OAAO;YACL,OAAO,MAAM,IAAI,IAAI;QACvB;QAEA,qBAAqB;QACrB,MAAM,WAAW,MAAM,MAAM,SAAS;YACpC,QAAQ;YACR;YACA,SAAS,YAAY,QAAQ,CAAC,yBAC1B,YACA;gBAAE,gBAAgB;YAAY;YAClC,OAAO;QACT;QAEA,MAAM,UAAU,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;QAExD,IAAI,YAAY;YACd,OAAO;YACP,OAAO,IAAI,SAAS,SAAS,IAAI,EAAE;gBACjC,QAAQ,SAAS,MAAM;gBACvB,SAAS,YAAY;oBACnB,gBAAgB,WAAW;gBAC7B;YACF;QACF;QAEA,YAAY;QACZ,IAAI,QAAQ,QAAQ,CAAC,qBAAqB;YACxC,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,OAAO,0NAAY,CAAC,IAAI,CAAC,MAAM;gBAAE,SAAS;YAAc;QAC1D,OAAO;YACL,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,OAAO,IAAI,SAAS,MAAM;gBACxB,SAAS,YAAY;oBAAE,gBAAgB,WAAW;gBAAa;YACjE;QACF;IACF,EAAE,OAAO,GAAQ;QACf,sCAAsC;QACtC,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,0NAAY,CAAC,IAAI,CACtB;YAAE,OAAO,GAAG,WAAW,OAAO;QAAG,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}